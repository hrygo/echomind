# EchoMind å‘é‡ç»´åº¦ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

EchoMindé‡‡ç”¨**è§„çº¦åŒ–å‘é‡ç»´åº¦ç®¡ç†ç­–ç•¥**ï¼Œç³»ç»Ÿåœ¨è¿è¡Œæ—¶åªæ”¯æŒä¸€ç§å›ºå®šçš„å‘é‡ç»´åº¦ã€‚è¿™ç§è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œæ€§èƒ½ï¼Œä½†è¦æ±‚åœ¨æ›´æ¢åµŒå…¥æ¨¡å‹æ—¶æ‰§è¡Œå¿…è¦çš„è¿ç§»æ­¥éª¤ã€‚

## âš ï¸ æ ¸å¿ƒåŸåˆ™

### 1. å•ä¸€ç»´åº¦çº¦æŸ
- ç³»ç»Ÿæ•°æ®åº“schemaå®šä¹‰å›ºå®šå‘é‡ç»´åº¦ï¼š`vector(1024)`
- æ‰€æœ‰å‘é‡å¿…é¡»ç¬¦åˆç›¸åŒçš„ç»´åº¦è¦æ±‚
- ä¸åŒç»´åº¦çš„å‘é‡æ— æ³•åœ¨åŒä¸€ç³»ç»Ÿä¸­å…±å­˜

### 2. æ¨¡å‹ä¸ç»´åº¦ç»‘å®š
- æ¯ä¸ªåµŒå…¥æ¨¡å‹å…·æœ‰å›ºå®šçš„åŸç”Ÿç»´åº¦
- ç³»ç»Ÿé…ç½®å¿…é¡»æ˜ç¡®æŒ‡å®šç›®æ ‡ç»´åº¦
- é…ç½®ä¸å®é™…æ¨¡å‹ç»´åº¦ä¸åŒ¹é…æ—¶ä¼šå¯¼è‡´é”™è¯¯

### 3. å…¨é‡é‡å»ºæœºåˆ¶
- æ›´æ¢å‘é‡ç»´åº¦å¿…é¡»é‡å»ºæ‰€æœ‰ç°æœ‰å‘é‡
- ä½¿ç”¨Reindexå·¥å…·æ‰§è¡Œæ‰¹é‡é‡å»º
- é‡å»ºæœŸé—´ç³»ç»Ÿæœç´¢åŠŸèƒ½ä¸å¯ç”¨

### 4. æ•°æ®ä¸€è‡´æ€§ä¿è¯
- æ•°æ®åº“å±‚é¢å¼ºåˆ¶ç»´åº¦çº¦æŸ
- åº”ç”¨å±‚é¢è¿›è¡ŒåŸºæœ¬éªŒè¯
- æ–‡æ¡£æä¾›æ˜ç¡®çš„æ“ä½œæŒ‡å¯¼

## ğŸ”§ æ”¯æŒçš„åµŒå…¥æ¨¡å‹

| Provider | æ¨¡å‹åç§° | åŸç”Ÿç»´åº¦ | æ¨èä½¿ç”¨åœºæ™¯ | æˆæœ¬æ•ˆç›Š |
|----------|----------|----------|--------------|----------|
| **SiliconFlow** | BAAI/bge-m3 | **1024** | ä¸­æ–‡ä¼˜åŒ–/å½“å‰é»˜è®¤ | â­â­â­â­â­ |
| **OpenAI** | text-embedding-3-small | 1536 | é«˜ç²¾åº¦è‹±æ–‡åœºæ™¯ | â­â­â­ |
| **Gemini** | text-embedding-004 | 768 | Googleç”Ÿæ€é›†æˆ | â­â­â­â­ |
| **Ollama** | nomic-embed-text | 768 | æœ¬åœ°éƒ¨ç½²æ–¹æ¡ˆ | â­â­â­ |

**æ³¨æ„**: å½“å‰ç³»ç»Ÿé…ç½®ä¸º1024ç»´åº¦ï¼ˆSiliconFlowï¼‰ï¼Œå…¶ä»–æ¨¡å‹éœ€è¦ç›¸åº”è°ƒæ•´ã€‚

## ğŸ”„ åµŒå…¥æ¨¡å‹æ›´æ¢æµç¨‹

### å‡†å¤‡é˜¶æ®µ
```bash
# 1. ç¡®è®¤æ–°æ¨¡å‹çš„ç»´åº¦ä¿¡æ¯
# 2. å¤‡ä»½ç°æœ‰å‘é‡æ•°æ®ï¼ˆé‡è¦ï¼ï¼‰
docker exec deploy-db-1 pg_dump -U user -d echomind_db -t email_embeddings > embeddings_backup_$(date +%Y%m%d_%H%M%S).sql

# 3. åœæ­¢åº”ç”¨æœåŠ¡
make stop-backend
```

### æ‰§è¡Œé˜¶æ®µ
```bash
# 4. æ›´æ–°æ•°æ®åº“schemaï¼ˆä»¥1024ç»´åº¦ä¸ºä¾‹ï¼‰
docker exec deploy-db-1 psql -U user -d echomind_db -c "ALTER TABLE email_embeddings ALTER COLUMN vector TYPE vector(1024);"

# 5. æ›´æ–°åº”ç”¨é…ç½®
# ç¼–è¾‘ configs/config.yaml:
# - ai.active_services.embedding: æ–°provider
# - ai.providers.newprovider.embedding_dimensions: æ–°ç»´åº¦å€¼

# 6. æ¸…ç†ç°æœ‰å‘é‡æ•°æ®
docker exec deploy-db-1 psql -U user -d echomind_db -c "DELETE FROM email_embeddings;"
```

### é‡å»ºé˜¶æ®µ
```bash
# 7. é‡æ–°ç”Ÿæˆæ‰€æœ‰å‘é‡
go run cmd/reindex/main.go --config configs/config.yaml

# 8. éªŒè¯é‡å»ºç»“æœ
docker exec deploy-db-1 psql -U user -d echomind_db -c "SELECT dimensions, COUNT(*) FROM email_embeddings GROUP BY dimensions;"

# 9. é‡å¯åº”ç”¨æœåŠ¡
make run-backend
```

### éªŒè¯é˜¶æ®µ
```bash
# 10. æµ‹è¯•æœç´¢åŠŸèƒ½
curl -X GET "http://localhost:8080/api/v1/search?q=test&limit=5" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## ğŸš¨ å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ

### é”™è¯¯1: ç»´åº¦ä¸åŒ¹é…
```
ERROR: different vector dimensions 1536 and 1024 (SQLSTATE 22000)
```

**åŸå› **: æ•°æ®åº“schemaä¸å‘é‡å®é™…ç»´åº¦ä¸åŒ¹é…
**è§£å†³**: æ‰§è¡Œå®Œæ•´çš„æ¨¡å‹æ›´æ¢æµç¨‹ï¼Œæ›´æ–°æ•°æ®åº“schema

### é”™è¯¯2: ç©ºå‘é‡
```
failed to embed query: empty embedding vector generated
```

**åŸå› **: AIæä¾›å•†è¿”å›ç©ºå‘é‡æˆ–é…ç½®é”™è¯¯
**è§£å†³**: æ£€æŸ¥APIå¯†é’¥ã€æ¨¡å‹é…ç½®å’Œç½‘ç»œè¿æ¥

### é”™è¯¯3: é‡å»ºå¤±è´¥
```
Reindex complete {"success": 0, "failed": 22}
```

**åŸå› **: é…ç½®é”™è¯¯ã€APIé™åˆ¶æˆ–æ•°æ®åº“è¿æ¥é—®é¢˜
**è§£å†³**: æ£€æŸ¥é…ç½®æ–‡ä»¶ã€APIé…é¢å’Œæ•°æ®åº“çŠ¶æ€

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### ç»´åº¦ä¸æ€§èƒ½å…³ç³»
| ç»´åº¦ | å†…å­˜æ¶ˆè€— | æœç´¢é€Ÿåº¦ | å­˜å‚¨ç©ºé—´ | ç²¾åº¦è¡¨ç° |
|------|----------|----------|----------|----------|
| **768** | ä½ | å¿« | å° | è‰¯å¥½ |
| **1024** | ä¸­ç­‰ | ä¸­ç­‰ | ä¸­ç­‰ | ä¼˜ç§€ |
| **1536** | é«˜ | æ…¢ | å¤§ | æœ€ä½³ |

### æ¨èé…ç½®
- **ç”Ÿäº§ç¯å¢ƒ**: 1024ç»´åº¦ï¼ˆå¹³è¡¡æ€§èƒ½ä¸ç²¾åº¦ï¼‰
- **å¼€å‘ç¯å¢ƒ**: 768ç»´åº¦ï¼ˆèŠ‚çœèµ„æºï¼‰
- **ç ”ç©¶ç¯å¢ƒ**: 1536ç»´åº¦ï¼ˆæœ€é«˜ç²¾åº¦ï¼‰

## ğŸ› ï¸ ç»´æŠ¤æœ€ä½³å®è·µ

### å®šæœŸæ£€æŸ¥
```bash
# æ£€æŸ¥å‘é‡ç»´åº¦ä¸€è‡´æ€§
docker exec deploy-db-1 psql -U user -d echomind_db -c "SELECT dimensions, COUNT(*) FROM email_embeddings GROUP BY dimensions;"

# æ£€æŸ¥å‘é‡ç´¢å¼•çŠ¶æ€
docker exec deploy-db-1 psql -U user -d echomind_db -c "\di email_embeddings_vector_idx"
```

### å¤‡ä»½ç­–ç•¥
- æ¯å‘¨è‡ªåŠ¨å¤‡ä»½å‘é‡æ•°æ®
- æ¨¡å‹æ›´æ¢å‰æ‰‹åŠ¨å¤‡ä»½
- ä¿ç•™æœ€è¿‘3ä¸ªæœˆçš„å¤‡ä»½æ–‡ä»¶

### ç›‘æ§æŒ‡æ ‡
- å‘é‡ç”ŸæˆæˆåŠŸç‡
- æœç´¢å“åº”æ—¶é—´
- æ•°æ®åº“è¿æ¥çŠ¶æ€
- APIè°ƒç”¨é¢‘ç‡é™åˆ¶

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [APIæœç´¢æ—¶åºå›¾](./api_search_sequence_diagram.md)
- [ç³»ç»Ÿæ¶æ„æ–‡æ¡£](./ARCHITECTURE.md)
- [éƒ¨ç½²æŒ‡å—](./DEPLOYMENT.md)
- [æ•…éšœæ’é™¤æ‰‹å†Œ](./TROUBLESHOOTING.md)

## ğŸ’¡ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°å‘é‡ç»´åº¦ç›¸å…³é—®é¢˜ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. **æ£€æŸ¥é…ç½®**: ç¡®è®¤`configs/config.yaml`ä¸­çš„ç»´åº¦è®¾ç½®
2. **æŸ¥çœ‹æ—¥å¿—**: æ£€æŸ¥åº”ç”¨å’Œæ•°æ®åº“æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. **å‚è€ƒæ–‡æ¡£**: æŸ¥é˜…æœ¬æ–‡æ¡£å’Œç›¸å…³æŠ€æœ¯æ–‡æ¡£
4. **è”ç³»æ”¯æŒ**: æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œç³»ç»Ÿé…ç½®

---

**æ›´æ–°æ—¶é—´**: 2025-11-26
**ç‰ˆæœ¬**: v1.0
**ç»´æŠ¤è€…**: EchoMindå¼€å‘å›¢é˜Ÿ